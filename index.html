<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Ensure proper scaling on mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Tunnel Cost Calculator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Google Font for modern look -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body {
      background: #f5f5f5;
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
    }
    /* Fixed container centered in the viewport */
    .container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90vw;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 20px 30px;
    }
    h1, h2, h3 {
      color: #333;
      margin-top: 0;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 500;
    }
    input[type="time"],
    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 16px;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    button:hover {
      background: #0056b3;
    }
    .participant {
      position: relative;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .remove-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #f44336;
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .remove-btn:hover {
      background: #d32f2f;
    }
    .breakdown {
      font-size: 14px;
      margin-left: 20px;
    }
    hr {
      margin: 20px 0;
      border: 0;
      border-top: 1px solid #eee;
    }
    .summary {
      background: #e9ecef;
      padding: 15px;
      border-radius: 4px;
      font-size: 16px;
    }
    #resultHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    #copyResultsBtn, #clearDataBtn {
      background: #28a745;
      border: none;
      color: #fff;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    #copyResultsBtn:hover, #clearDataBtn:hover {
      background: #218838;
    }
    a.spare-link {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
    }
    a.spare-link:hover {
      text-decoration: underline;
    }
    /* Mobile-specific adjustments (optional, since container is fixed) */
    @media (max-width: 600px) {
      body {
        font-size: 18px;
      }
      input, button {
        font-size: 18px;
      }
      .breakdown {
        font-size: 16px;
      }
      .summary {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Music Tunnel Cost Calculator</h1>
    
    <!-- Only asking for Actual Total Paid -->
    <div>
      <label for="actualPaid">Actual Total Paid ($):</label>
      <input type="number" id="actualPaid" placeholder="e.g., 100.00" step="0.01">
    </div>
    
    <h2>Participants</h2>
    <p>
      Enter each participant’s join and leave time below (or scan an NFC tag with a URL like <code>?name=Alice</code>).<br>
      For spare/new/random people, use this link:
      <a class="spare-link" href="?new=1">Spare NFC Link</a>
    </p>
    <div id="participants"></div>
    <button onclick="addParticipant()">Add Participant</button>
    <button id="clearDataBtn" onclick="clearData()">Clear Data</button>
    
    <br>
    <button onclick="calculateCosts()">Calculate Costs</button>
    
    <div id="resultHeader">
      <h2>Results</h2>
      <button id="copyResultsBtn" onclick="copyResults()">Copy Results</button>
    </div>
    <div id="results"></div>
  </div>
  
  <script>
    // --- Utility Functions ---
    function pad(num) {
      return num.toString().padStart(2, '0');
    }
    
    // Converts a time string (HH:MM) to minutes since midnight.
    function timeToMinutes(timeStr) {
      const parts = timeStr.split(':');
      return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
    }
    
    // Formats minutes as HH:MM.
    function formatTime(totalMinutes) {
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      return `${pad(hours)}:${pad(minutes)}`;
    }
    
    function getCurrentLocalTime() {
      const now = new Date();
      return `${pad(now.getHours())}:${pad(now.getMinutes())}`;
    }
    
    // --- Global Cost Function ---
    function getHourlyRate(activeCount, currentTime) {
      const sevenPM = 19 * 60;
      const isEvening = currentTime >= sevenPM;
      if (activeCount >= 1 && activeCount <= 3) {
        return isEvening ? 39 : 29;
      } else if (activeCount <= 5) {
        return isEvening ? 59 : 49;
      } else if (activeCount <= 8) {
        return isEvening ? 79 : 69;
      } else if (activeCount <= 10) {
        return isEvening ? 99 : 89;
      } else if (activeCount <= 15) {
        return isEvening ? 129 : 109;
      } else if (activeCount <= 20) {
        return isEvening ? 139 : 129;
      } else {
        return isEvening ? 139 : 129;
      }
    }
    
    // --- Persistence Functions ---
    function saveParticipants() {
      const participants = [];
      const participantElems = document.querySelectorAll('.participant');
      participantElems.forEach(elem => {
        const name = elem.querySelector('.participantName').value;
        const joinTime = elem.querySelector('.joinTime').value;
        const leaveTime = elem.querySelector('.leaveTime').value;
        if (name || joinTime || leaveTime) {
          participants.push({ name, joinTime, leaveTime });
        }
      });
      localStorage.setItem("participants", JSON.stringify(participants));
    }
    
    function loadParticipants() {
      const saved = localStorage.getItem("participants");
      if (saved) {
        try {
          const participants = JSON.parse(saved);
          participants.forEach(p => {
            addParticipant(p);
          });
        } catch (e) {
          console.error("Error parsing participant data", e);
        }
      }
    }
    
    // --- Participant Block ---
    // If participantData is provided, use its values; otherwise, use defaults.
    function addParticipant(participantData) {
      const container = document.getElementById('participants');
      const div = document.createElement('div');
      div.className = 'participant';
      
      // Create and append the remove button.
      const removeBtn = document.createElement('div');
      removeBtn.className = 'remove-btn';
      removeBtn.title = "Remove this participant";
      removeBtn.innerHTML = '&times;';
      removeBtn.addEventListener('click', () => {
        div.remove();
        saveParticipants();
      });
      div.appendChild(removeBtn);
      
      const contentDiv = document.createElement('div');
      // For new participant default join time is current time.
      let suggestedJoin = getCurrentLocalTime();
      let suggestedLeave = "";
      
      const nameVal = participantData ? participantData.name : "";
      const joinVal = participantData ? participantData.joinTime : suggestedJoin;
      const leaveVal = participantData ? participantData.leaveTime : suggestedLeave;
      
      contentDiv.innerHTML = `
        <label>Name: <input type="text" class="participantName" placeholder="Name" value="${nameVal}"></label>
        <label>Join Time: <input type="time" class="joinTime" value="${joinVal}"></label>
        <label>Leave Time: <input type="time" class="leaveTime" value="${leaveVal}"></label>
      `;
      
      contentDiv.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', saveParticipants);
      });
      
      div.appendChild(contentDiv);
      container.appendChild(div);
      saveParticipants();
    }
    
    // --- Calculation and Copy Functions ---
    // Global variable to store the minimal formatted result text (only name and adjusted cost).
    let lastTextResult = "";
    
    // Calculate costs by computing the session period from the earliest join to the latest leave.
    function calculateCosts() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      
      const actualPaid = parseFloat(document.getElementById('actualPaid').value);
      
      // Gather participant data.
      const participantElems = document.querySelectorAll('.participant');
      const participants = [];
      const joinTimes = [];
      const leaveTimes = [];
      participantElems.forEach(elem => {
        const name = elem.querySelector('.participantName').value.trim() || 'Unnamed';
        const joinTime = elem.querySelector('.joinTime').value;
        const leaveTime = elem.querySelector('.leaveTime').value;
        if (!joinTime || !leaveTime) return;
        joinTimes.push(timeToMinutes(joinTime));
        leaveTimes.push(timeToMinutes(leaveTime));
        participants.push({ name, joinTime, leaveTime, computedCost: 0, breakdown: [] });
      });
      
      if (participants.length === 0) {
        resultsDiv.innerText = 'Please add at least one valid participant.';
        return;
      }
      
      const sessionStartMinutes = Math.min(...joinTimes);
      const sessionEndMinutes = Math.max(...leaveTimes);
      const duration = sessionEndMinutes - sessionStartMinutes;
      if (duration <= 0) {
        resultsDiv.innerText = 'Invalid time range among participants.';
        return;
      }
      
      let computedSessionTotal = 0;
      // Simulate minute-by-minute over the computed session.
      for (let minute = 0; minute < duration; minute++) {
        const currentTime = sessionStartMinutes + minute;
        const activeParticipants = participants.filter(p => {
          const jt = timeToMinutes(p.joinTime);
          const lt = timeToMinutes(p.leaveTime);
          return jt <= currentTime && currentTime < lt;
        });
        const activeCount = activeParticipants.length;
        if (activeCount === 0) continue;
        const groupHourlyRate = getHourlyRate(activeCount, currentTime);
        const costForThisMinute = groupHourlyRate / 60;
        computedSessionTotal += costForThisMinute;
        const costPerPerson = costForThisMinute / activeCount;
        
        activeParticipants.forEach(p => {
          p.computedCost += costPerPerson;
          // Group consecutive minutes with the same effective per-minute cost.
          if (p.breakdown.length > 0) {
            let last = p.breakdown[p.breakdown.length - 1];
            if (last.effectiveRate === costPerPerson && last.endMinute === minute) {
              last.endMinute = minute + 1;
              last.cost += costPerPerson;
            } else {
              p.breakdown.push({
                startMinute: minute,
                endMinute: minute + 1,
                effectiveRate: costPerPerson,
                cost: costPerPerson,
                groupHourlyRate: groupHourlyRate,
                activeCount: activeCount
              });
            }
          } else {
            p.breakdown.push({
              startMinute: minute,
              endMinute: minute + 1,
              effectiveRate: costPerPerson,
              cost: costPerPerson,
              groupHourlyRate: groupHourlyRate,
              activeCount: activeCount
            });
          }
        });
      }
      
      let factor = 1;
      if (!isNaN(actualPaid) && actualPaid > 0) {
        factor = actualPaid / computedSessionTotal;
      }
      
      participants.forEach(p => {
        p.adjustedCost = p.computedCost * factor;
      });
      
      // Build detailed HTML result output (showing full breakdown).
      let html = '<ul>';
      participants.forEach(p => {
        html += `<li><strong>${p.name}</strong>:<br>
                 Computed Cost: $${p.computedCost.toFixed(2)}<br>
                 <strong>Adjusted Cost:</strong> $${p.adjustedCost.toFixed(2)}<br>
                 <em>Breakdown:</em><ul class="breakdown">`;
        p.breakdown.forEach(interval => {
          const intervalStart = formatTime(sessionStartMinutes + interval.startMinute);
          const intervalEnd = formatTime(sessionStartMinutes + interval.endMinute);
          const minutesSpent = interval.endMinute - interval.startMinute;
          html += `<li>From ${intervalStart} to ${intervalEnd} (${minutesSpent} minute${minutesSpent > 1 ? 's' : ''})<br>
                   Group rate: $${interval.groupHourlyRate}/hr with ${interval.activeCount} active<br>
                   Each paid $${interval.effectiveRate.toFixed(4)}/min → $${interval.cost.toFixed(2)}</li>`;
        });
        html += '</ul></li>';
      });
      html += '</ul>';
      
      html += `<hr>
               <h3>Summary</h3>
               <div class="summary">
                 <ul>
                   <li>Computed Session Total: $${computedSessionTotal.toFixed(2)}</li>
                   <li>Actual Total Paid: ${!isNaN(actualPaid) && actualPaid > 0 ? '$' + actualPaid.toFixed(2) : 'Not provided (using computed total)'}</li>
                   <li>Adjustment Factor: ${factor.toFixed(4)}</li>
                   <li>Sum of Adjusted Participant Costs: $${participants.reduce((s, p) => s + p.adjustedCost, 0).toFixed(2)}</li>
                 </ul>
               </div>`;
      
      resultsDiv.innerHTML = html;
      
      // Build minimal text result (only name and adjusted cost) for copying.
      let copyTextResult = "Participant Costs:\n\n";
      participants.forEach(p => {
        copyTextResult += `${p.name}: $${p.adjustedCost.toFixed(2)}\n`;
      });
      lastTextResult = copyTextResult;
      
      saveParticipants();
    }
    
    // Copies the minimal formatted result text to the clipboard.
    function copyResults() {
      if (!lastTextResult) {
        alert("No results available to copy. Please calculate the results first.");
        return;
      }
      navigator.clipboard.writeText(lastTextResult).then(() => {
        alert("Participant names and costs copied to clipboard!");
      }).catch(err => {
        alert("Failed to copy results: " + err);
      });
    }
    
    // --- NFC Tag Integration via URL Query Parameter ---
    // If the URL contains a "name" parameter (e.g. ?name=Alice), then:
    // - If a participant with that name exists, update their leave time to the current time.
    // - Otherwise, add a new participant with that name and set the join time to current time.
    // If the URL contains "new" (and no "name"), prompt for a name.
    function processNfcScan() {
      const params = new URLSearchParams(window.location.search);
      let scannedName = params.get("name");
      if (!scannedName && params.has("new")) {
        scannedName = prompt("Enter your name:");
      }
      if (scannedName) {
        const currentTime = getCurrentLocalTime();
        const participantElems = document.querySelectorAll('.participant');
        let found = false;
        participantElems.forEach(elem => {
          const nameInput = elem.querySelector('.participantName');
          if (nameInput && nameInput.value.trim().toLowerCase() === scannedName.trim().toLowerCase()) {
            // Update leave time if current time is later.
            const leaveInput = elem.querySelector('.leaveTime');
            if (!leaveInput.value || leaveInput.value < currentTime) {
              leaveInput.value = currentTime;
              alert(`Logged leave time for ${scannedName} at ${currentTime}`);
            } else {
              alert(`Participant ${scannedName} already has a leave time set.`);
            }
            found = true;
          }
        });
        if (!found) {
          addParticipant({ name: scannedName, joinTime: getCurrentLocalTime(), leaveTime: "" });
          alert(`Logged join time for ${scannedName} at ${getCurrentLocalTime()}`);
        }
        saveParticipants();
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }
    
    // --- Clear Data Function ---
    function clearData() {
      if (confirm("Are you sure you want to clear all participant data?")) {
        localStorage.removeItem("participants");
        document.getElementById('participants').innerHTML = "";
        document.getElementById('results').innerHTML = "";
        alert("All data cleared!");
      }
    }
    
    window.addEventListener('load', () => {
      loadParticipants();
      processNfcScan();
    });
  </script>
</body>
</html>
